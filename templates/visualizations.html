{% extends "base.html" %}

{% block title %}Visualizations - Smart Retail Analytics Platform{% endblock %}

{% block content %}
<div class="glass-card">
    <h2 class="section-title">ğŸ“ˆ Visualizations & Insights</h2>
    
    <!-- Loading Message -->
    <div id="loadingMessage" class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading visualizations...</p>
    </div>
    
    <!-- No Data Message -->
    <div id="noDataMessage" class="alert alert-warning" style="display: none;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Please generate dataset first! 
        <a href="/data_generator" class="btn btn-primary ms-2">Go to Data Generator</a>
    </div>
    
    <!-- Visualizations Container -->
    <div id="visualizationsContainer" style="display: none;">
        <!-- Data Overview -->
        <h3 class="section-title">ğŸ“Š Data Overview</h3>
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="glass-card">
                    <h4>ğŸ“ˆ Sales Distribution</h4>
                    <div id="salesDistribution"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card">
                    <h4>ğŸ‘¥ Customer Demographics</h4>
                    <div id="ageDistribution"></div>
                </div>
            </div>
        </div>
        
        <!-- Customer Analysis -->
        <h3 class="section-title">ğŸ‘¥ Customer Analysis</h3>
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="glass-card">
                    <h4>ğŸ¯ Purchase Decision Analysis</h4>
                    <div id="purchaseDecision"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card">
                    <h4>â­ Loyalty Categories</h4>
                    <div id="loyaltyCategories"></div>
                </div>
            </div>
        </div>
        
        <!-- Correlation Analysis -->
        <h3 class="section-title">ğŸ”— Correlation Analysis</h3>
        <div class="glass-card mb-4">
            <h4>ğŸ“Š Feature Correlations</h4>
            <div id="correlationMatrix"></div>
        </div>
        
        <!-- Business Insights -->
        <h3 class="section-title">ğŸ’¼ Business Insights</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="glass-card">
                    <h4>ğŸ“ˆ Key Metrics</h4>
                    <div id="keyMetrics"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card">
                    <h4>ğŸ¯ Top Insights</h4>
                    <div id="topInsights"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load visualizations when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadVisualizations();
});

function loadVisualizations() {
    fetch('/get_visualizations')
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingMessage').style.display = 'none';
        
        if (data.success) {
            // Show visualizations
            document.getElementById('visualizationsContainer').style.display = 'block';
            
            // Plot charts
            Plotly.newPlot('salesDistribution', JSON.parse(data.visualizations.sales_distribution));
            Plotly.newPlot('ageDistribution', JSON.parse(data.visualizations.age_distribution));
            Plotly.newPlot('purchaseDecision', JSON.parse(data.visualizations.purchase_decision));
            Plotly.newPlot('loyaltyCategories', JSON.parse(data.visualizations.loyalty_categories));
            Plotly.newPlot('correlationMatrix', JSON.parse(data.visualizations.correlation_matrix));
            
            // Display insights
            const insights = data.insights;
            document.getElementById('keyMetrics').innerHTML = `
                <div class="metric-card mb-3">
                    <div class="metric-label">Average Monthly Sales</div>
                    <div class="metric-value">â‚¹${insights.avg_sales.toFixed(2)}</div>
                </div>
                <div class="metric-card mb-3">
                    <div class="metric-label">Total Customers</div>
                    <div class="metric-value">${insights.total_customers.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Purchase Rate</div>
                    <div class="metric-value">${insights.purchase_rate.toFixed(1)}%</div>
                </div>
            `;
            
            document.getElementById('topInsights').innerHTML = `
                <ul class="list-unstyled">
                    <li>ğŸ’ <strong>High-value customers</strong> earn â‚¹${insights.high_value_income.toLocaleString()} on average</li>
                    <li>ğŸ¯ <strong>Top 20% customers</strong> represent the most valuable segment</li>
                    <li>ğŸ“ˆ <strong>Sales variance</strong>: â‚¹${insights.sales_variance.toFixed(2)}</li>
                </ul>
            `;
            
        } else {
            // Show no data message
            document.getElementById('noDataMessage').style.display = 'block';
        }
    })
    .catch(error => {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('noDataMessage').innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            Error loading visualizations: ${error.message}
        `;
        document.getElementById('noDataMessage').style.display = 'block';
    });
}
</script>
{% endblock %}
